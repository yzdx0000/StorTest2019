# -*- coding:utf-8 8-*
#################################################
#该脚本用来不停的给主宕机，然后每次宕机后，等待从的oOms进程起来后执行s3操作，等主上电且oOms起来后执行s3的操作，反复10次
#################################################
import os,sys,commands,time
#import imports3libpath
import _fault_lyz
import _stability1lib_lyz
import common
import _fault_all_lyz
import deleteAllAccount_lyz
#参数说明：masterip：主的ip；slaveip：从的ip；pathOfScript:要执行的脚本在从上的路径; stabilityScript:要执行的s3的稳定性脚本名称,然后是_stability1lib_lyz这个脚本需要的参数
def mgrfaultAndS3(num,masterip,masteripmiip,slaveip,slaveipmiip,accountname,oossip,createBucketname,putObjectname,objectpath,downobjectpath,splitobjectname,splitobjectpathdir,splitfilename,numofsplit,cancleupobjectname,quota):
    num=int(num)
    faulto = _fault_all_lyz.fault()
    statusrecoveryo=_fault_all_lyz.statusrecovery()
    for i in range(num):
        print 'masteripmiip is %s' %masteripmiip
        #步骤1：给主mgr宕机
        faulto.poweroff(masteripmiip)
        print '*************************************************************************************************************'
        print '*************************************************************************************************************'
        print '*************************************************************************************************************'
        print '****************************主宕机第%s次成功，等待5分钟********************************************************' %(i)
        time.sleep(300)
        #步骤2：等待从接管
        statusrecoveryo.iftakeover(slaveip)

        #步骤3：等待从的oOms进程起来
        statusrecoveryo.ifprocessStart(slaveip,'oOms')

        #步骤4：执行s3的指令集
        re=_stability1lib_lyz.allOPerations(slaveip,accountname,oossip,createBucketname,putObjectname,objectpath,downobjectpath,splitobjectname,splitobjectpathdir,splitfilename,numofsplit,cancleupobjectname,quota)
        #deleteAllAccount_lyz.deleteAllAccount(slaveip,oossip)
        if re==-1:
            return -1
        #步骤5：将主重新上电
        faulto.poweron(masteripmiip)
        print ''
        print ''
        print '****************************主开机成功，等待十分钟***************************************************8'
        time.sleep(600)
        #步骤6：等待主开机
        statusrecoveryo.ifpoweron(masterip)

        #步骤7：等待主接管：
        statusrecoveryo.iftakeover(masterip)

        #步骤8：等待主的oOms起来
        statusrecoveryo.ifprocessStart(masterip,'oOms')

        #再次执行s3的指令集
        re=_stability1lib_lyz.allOPerations(masterip, accountname,oossip, createBucketname, putObjectname,objectpath, downobjectpath, splitobjectname, splitobjectpathdir, splitfilename,numofsplit, cancleupobjectname, quota)
        if re==-1:
            return -1
        #deleteAllAccount_lyz.deleteAllAccount(masterip, oossip)
        time.sleep(300)
if __name__=="__main__":
    #mgrfaultAndS3(masterip, slaveip, accountname, oossip, createBucketname, putObjectname, objectpath,downobjectpath, splitobjectname, splitobjectpathdir, splitfilename, numofsplit, cancleupobjectname,quota)
    mgrfaultAndS3(2,'100.100.100.16','10.2.40.66','100.100.100.17','10.2.40.67','s1123b','100.100.100.18','bucket1123b','object1123b','/opt/s3uploadfile/10Mfile','/opt/s3uploadfile/down','objectsplit1103o','/opt/s3uploadfile','test',2,'objectsplitcancle03o',1024)
