# -*- coding:utf-8 -*
import os,sys,commands
import _checkresult_lyz
#该脚本用来设置桶的acl
def setBucketAcl(oossip,bucketname,ownercertificateid,owner_accountuid,owneraccount_email,des_accountuid,dstaccount_email,operation):
	cmd="curl -i http://%s:20480/%s?acl -XPUT -H \"Authorization: AWS4-HMAC-SHA256 Credential=%s\" -d \'<?xml version=\"1.0\" encoding=\"UTF-8\"?><AccessControlPolicy xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><Owner><ID>%s</ID><DisplayName>%s</DisplayName></Owner><AccessControlList><Grant><Grantee xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"CanonicalUser\"><ID>%s</ID><DisplayName>%s</DisplayName></Grantee><Permission>%s</Permission></Grant></AccessControlList></AccessControlPolicy>'" %(oossip, bucketname, ownercertificateid, owner_accountuid, owneraccount_email, des_accountuid, dstaccount_email,operation)

	#cmd="curl -i http://%s:20480/%s?acl - XPUT - H \"Authorization:AWS4-HMAC-SHA256 Credential=%s\" -d \'<?xml version=\"1.0\" encoding=\"UTF-8\"?><AccessControlPolicy xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><Owner><ID>%s</ID><DisplayName>%s</DisplayName></Owner><AccessControlList><Grant><Grantee xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"CanonicalUser\"><ID>%s</ID><DisplayName>%s</DisplayName></Grantee><Permission>%s</Permission></Grant></AccessControlList></AccessControlPolicy>\'" % (oossip, bucketname, ownercertificateid, owner_accountuid, owneraccount_email, des_accountuid, dstaccount_email,operation)
	print cmd
	(status,output)=commands.getstatusoutput(cmd)
	print output
	re=_checkresult_lyz.checkresult(status,output)
	if re == -1:
		return -1

def setBucketAclHaveLog(oossip,bucketname,ownercertificateid,owner_accountuid,owneraccount_email,des_accountuid,dstaccount_email,operation,logger):
	cmd="curl -i http://%s:20480/%s?acl -XPUT -H \"Authorization: AWS4-HMAC-SHA256 Credential=%s\" -d \'<?xml version=\"1.0\" encoding=\"UTF-8\"?><AccessControlPolicy xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><Owner><ID>%s</ID><DisplayName>%s</DisplayName></Owner><AccessControlList><Grant><Grantee xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"CanonicalUser\"><ID>%s</ID><DisplayName>%s</DisplayName></Grantee><Permission>%s</Permission></Grant></AccessControlList></AccessControlPolicy>'" %(oossip, bucketname, ownercertificateid, owner_accountuid, owneraccount_email, des_accountuid, dstaccount_email,operation)

	#cmd="curl -i http://%s:20480/%s?acl - XPUT - H \"Authorization:AWS4-HMAC-SHA256 Credential=%s\" -d \'<?xml version=\"1.0\" encoding=\"UTF-8\"?><AccessControlPolicy xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><Owner><ID>%s</ID><DisplayName>%s</DisplayName></Owner><AccessControlList><Grant><Grantee xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"CanonicalUser\"><ID>%s</ID><DisplayName>%s</DisplayName></Grantee><Permission>%s</Permission></Grant></AccessControlList></AccessControlPolicy>\'" % (oossip, bucketname, ownercertificateid, owner_accountuid, owneraccount_email, des_accountuid, dstaccount_email,operation)
	logger.info(cmd)
	(status,output)=commands.getstatusoutput(cmd)
	logger.info(output)
	re=_checkresult_lyz.checkresultHaveLog(status,output,logger)
	if re == -1:
		return -1
if __name__=="__main__":
	#setBucketAcl(sys.argv[1],sys.argv[2],sys.argv[3],sys.argv[4],sys.argv[5],sys.argv[6],sys.argv[7],sys.argv[8])
	setBucketAcl('10.2.40.18', 'acl1031', '000024OZMBDHHAHA000025XC0GHKSMWE', '000024OZMBDHHAHA00001ZJXZXL623PS', 'lyz8@sugon.com', '000024OZMUUF9H5L00001ZJXZXL623PS', 'lyz2@sugon.com','READ')
