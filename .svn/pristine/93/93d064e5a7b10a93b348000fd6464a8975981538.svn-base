# -*- coding:utf-8 -*- 
#**********************************************#
#标题：根据账户名获取账户id模块
#使用方法：调用"query_database(mgr_ip,acc_name)"函数，指定主MGR的ip、账户名即可。
#作者：王建磊
#创建时间：2017/11/07
#更新时间：2017/11/07
#**********************************************#

#第三方模块，需手动安装，python不自带该模块（psycopg2）
import psycopg2
import sys

#连接数据库，查询数据表，根据账户名获取账户信息，从而得到账户id
#输入mgr_ip、账户名，获得账户uid、accid和email
def query_database(mgr_ip,acc_name):
	conn = psycopg2.connect(database="pos_iam",user="postgres",host=mgr_ip,port="5432")
	cur = conn.cursor()
	sqlcmd = "select acct_start_keyid from acct_table_1 where acct_name='"+acc_name+"';"
	cur.execute(sqlcmd)
	rows = cur.fetchall()
	print rows
	if rows == []:
		print "The acct_start_keyid data of account \"%s\" doesn't exist."%acc_name
		return 0
	else:
		for i in range(1,60):
			sqlcmd = "select "+"secretkey"+" from key_table_"+str(i)+" where key_id='"+str(rows[0][0])+"';"
			cur.execute(sqlcmd)
			rows2 = cur.fetchall()
			if rows2 == []:
				continue
			else:
				break
	conn.commit()
	cur.close()
	conn.close()
	return rows2[0][0]

def obtain_accid(mgr_ip,acc_name):
	acctid,accid,email = query_database(mgr_ip,acc_name)
	return accid
	
if __name__ == '__main__':
	sk = query_database(sys.argv[1],sys.argv[2])
	print sk
