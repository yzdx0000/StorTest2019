#!/usr/bin/python 
# -*- coding:utf-8 -*
#***************************************************************
#实现功能：head_bucket脚本用于查询桶的元数据
#所需参数:mgrip，oossip，bucketname，accountname，email
#注意：只有对该桶有READ权限的用户才可以查看
#作者：刘萍
#修改日期：2018/01/12
#**************************************************************

import os,sys
import commands
import _readconffile_lp
import _getrelatedid_lp
import getoutputpath_lp
import _log_lp
import commonfunction_lp

def head_bucket_logger(mgrip,oossip,bucketname,accountname,email,logger):
    (accountid,accountuid,certificateid)=_getrelatedid_lp.accountrea_logger(mgrip,accountname,email,logger)
    cmd='curl -s -i http://%s:20480/%s?acl -X HEAD -H "Authorization: AWS4-HMAC-SHA256 Credential=%s"' %(oossip,bucketname,certificateid)
    logger.info(cmd)
    output=os.popen(cmd).read()
    logger.info(output)
    num1=output.find('HTTP/1.1')
    num2=output[(num1+9):((num1+12))]
    if(num2=='200'):
        logger.info(("get bucket meta of %s success!") % bucketname)
    else:
        logger.info(("***************get bucket meta of %s fail!***************") % bucketname)
        return -1
if __name__=="__main__":
    args=_readconffile_lp.readconf()
    #    print args
    # 第二个步骤：创建logger
    logfilename='test'
    # 创建日志输出文件
    output = getoutputpath_lp.getoutputpath()
    logfilepath = os.path.join(output, logfilename)
    ifmkdir = commonfunction_lp.touchfile(logfilepath)
    logger = _log_lp.log(logfilename)
    if ifmkdir:
        logger.info('%s is alreay exists and we delete it and create a new one' % logfilepath)
    else:
        logger.info('%s is created ok' % logfilepath)

    head_bucket_logger(args['master_mgr_ip'],args['oossip'],args['thebucket'],args['accountname'],args['email'],logger)


